<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>در حال بارگذاری...</title>
  <style>
    body, html { margin:0; padding:0; height:100%; background:#f0f2f5; display:flex; flex-direction:column; justify-content:center; align-items:center; font-family:Tahoma; overflow:hidden; }
    .loader { width:60px; height:60px; border:6px solid #e0e0e0; border-top:6px solid #007bff; border-radius:50%; animation:spin 1s linear infinite; margin-bottom:20px; }
    .text { color:#555; font-size:16px; }
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
  </style>
</head>
<body>
  <div class="loader"></div>
  <div class="text">در حال بارگذاری...</div>

<script>
window.addEventListener('load', async () => {
  await new Promise(r => setTimeout(r, 2500)); // کمی بیشتر صبر می‌کنیم

  const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  const ua = navigator.userAgent;

  // تشخیص مدل دقیق موبایل — نسخه فوق‌العاده با Client Hints
  async function getDeviceModel() {
    // اول Client Hints (بهترین راه برای Chrome جدید)
    if (navigator.userAgentData) {
      try {
        const uaData = await navigator.userAgentData.getHighEntropyValues([
          'model', 'platformVersion', 'fullVersionList'
        ]);
        if (uaData.model && uaData.model !== 'K' && uaData.model !== '') {
          return uaData.model.trim();
        }
      } catch (e) {
        console.log('Client Hints failed:', e);
      }
    }

    // fallback به regex
    const androidModel = ua.match(/Android[^;]+; ([^;\)]+) Build\//);
    if (androidModel && androidModel[1]) {
      return androidModel[1].trim();
    }

    if (ua.includes('Build/')) {
      const buildMatch = ua.match(/; ([A-Z0-9]{3,}) Build\//);
      if (buildMatch && buildMatch[1]) {
        return buildMatch[1].trim();
      }
    }

    if (ua.includes('iPhone') || ua.includes('iPad') || ua.includes('iPod')) {
      const iosMatch = ua.match(/\((iPhone|iPad|iPod)/);
      return iosMatch ? iosMatch[1] : 'iOS Device';
    }

    return 'Android Generic (K)';
  }

  const deviceModel = await getDeviceModel();

  const data = {
    userAgent: ua,
    platform: navigator.platform,
    device_model: deviceModel,
    screen: `${screen.width}x${screen.height}`,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    language: navigator.language,
    languages: navigator.languages,
    cookieEnabled: navigator.cookieEnabled,
    online: navigator.onLine,
    doNotTrack: navigator.doNotTrack,
    hardware: navigator.hardwareConcurrency + ' هسته',
    memory: navigator.deviceMemory ? navigator.deviceMemory + 'GB' : 'نامشخص',
    network: conn ? {
      type: conn.effectiveType,
      downlink: conn.downlink + 'Mbps',
      rtt: conn.rtt + 'ms',
      saveData: conn.saveData
    } : 'نامشخص',
    battery: 'getBattery' in navigator ? await navigator.getBattery().then(b => ({
      level: (b.level * 100).toFixed(0) + '%',
      charging: b.charging
    })) : 'نامشخص',
    webrtc_ips: await getWebRTCIPs()
  };

  try {
    await fetch('/log', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      keepalive: true
    });
  } catch (e) {
    console.error('خطا در ارسال:', e);
  }
});

function getWebRTCIPs() {
  return new Promise(resolve => {
    const ips = new Set();
    let pc;
    try {
      pc = new RTCPeerConnection({ iceServers: [] });
      pc.createDataChannel('');
      pc.createOffer().then(offer => pc.setLocalDescription(offer)).catch(() => {});
      pc.onicecandidate = e => {
        if (!e.candidate) return;
        const match = e.candidate.candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
        if (match) ips.add(match[1]);
      };
    } catch {}
    setTimeout(() => {
      if (pc) pc.close();
      resolve([...ips]);
    }, 3000);
  });
}
</script>
</body>
</html>