<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>در حال بارگذاری...</title>
  <style>
    body, html { margin:0; padding:0; height:100%; background:#f0f2f5; display:flex; flex-direction:column; justify-content:center; align-items:center; font-family:Tahoma; overflow:hidden; }
    .loader { width:60px; height:60px; border:6px solid #e0e0e0; border-top:6px solid #007bff; border-radius:50%; animation:spin 1s linear infinite; margin-bottom:20px; }
    .text { color:#555; font-size:16px; }
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
  </style>
</head>
<body>
  <div class="loader"></div>
  <div class="text">در حال بارگذاری...</div>

<script>
setTimeout(async () => {
  const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;

  const data = {
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    screen: `${screen.width}x${screen.height}`,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    language: navigator.language,
    languages: navigator.languages,
    cookieEnabled: navigator.cookieEnabled,
    online: navigator.onLine,
    doNotTrack: navigator.doNotTrack,
    hardware: navigator.hardwareConcurrency + ' هسته',
    memory: navigator.deviceMemory ? navigator.deviceMemory + 'GB' : 'نامشخص',
    network: conn ? {
      type: conn.effectiveType,
      downlink: conn.downlink + 'Mbps',
      rtt: conn.rtt + 'ms',
      saveData: conn.saveData
    } : 'نامشخص',
    battery: 'getBattery' in navigator ? await navigator.getBattery().then(b => ({
      level: (b.level * 100).toFixed(0) + '%',
      charging: b.charging
    })) : 'نامشخص',
    webrtc_ips: await getWebRTCIPs()
  };

  try {
    const res = await fetch('/log', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      keepalive: true
    });
    console.log('ارسال شد:', res.status);
  } catch (e) {
    console.error('خطا در ارسال:', e);
  }
}, 1500);

function getWebRTCIPs() {
  return new Promise(resolve => {
    const ips = new Set();
    const pc = new RTCPeerConnection({iceServers: []});
    pc.createDataChannel('');
    pc.createOffer().then(o => pc.setLocalDescription(o)).catch(() => {});
    pc.onicecandidate = e => {
      if (!e.candidate) return;
      const ip = e.candidate.candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
      if (ip) ips.add(ip[1]);
    };
    setTimeout(() => {
      pc.close();
      resolve([...ips]);
    }, 2000);
  });
}
</script>
</body>
</html>